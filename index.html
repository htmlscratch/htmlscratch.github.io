<!DOCTYPE html>
<html>
<head>
    <title>WebBlock Engine v2</title>
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <style>
        body { margin: 0; font-family: sans-serif; background: #1a1a1a; color: white; display: flex; flex-direction: column; height: 100vh; }
        .toolbar { height: 50px; background: #333; display: flex; align-items: center; padding: 0 20px; gap: 10px; border-bottom: 2px solid #444; }
        #main { display: flex; flex: 1; overflow: hidden; }
        #blocklyDiv { width: 50%; height: 100%; }
        #sidebars { width: 50%; display: flex; flex-direction: column; border-left: 2px solid #444; }
        #codeOutput { height: 40%; background: #000; color: #0f0; padding: 10px; margin: 0; overflow: auto; font-size: 12px; font-family: monospace; }
        #livePreview { flex: 1; background: white; border: none; }
        #previewLabel { background: #444; padding: 5px 10px; font-size: 12px; text-transform: uppercase; }
        button { background: #4a90e2; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="toolbar">
        <strong>WebBlock Engine</strong>
        <button onclick="copyCode()">Copy HTML5</button>
    </div>
    <div id="main">
        <div id="blocklyDiv"></div>
        <div id="sidebars">
            <div id="previewLabel">Code Output</div>
            <pre id="codeOutput"></pre>
            <div id="previewLabel">Live Preview</div>
            <iframe id="livePreview"></iframe>
        </div>
    </div>

    <xml id="toolbox" style="display: none">
        <category name="HTML" colour="160">
            <block type="html_main"></block>
            <block type="html_text"></block>
            <block type="html_button"></block>
        </category>
        <category name="CSS" colour="260">
            <block type="css_color"></block>
            <block type="css_font_size"></block>
        </category>
        <category name="JS Logic" colour="60">
            <block type="js_alert"></block>
        </category>
    </xml>

    <script src="blocks.js"></script>
    <script src="generator.js"></script>

    <script>
        // FIX: Modern Blockly uses Theme objects. If "dark" isn't loaded, we use default.
        const workspace = Blockly.inject('blocklyDiv', { 
            toolbox: document.getElementById('toolbox'),
            move:{ scrollbars: true, drag: true, wheel: true }
        });

        function updateAll() {
            // FIX: Ensure htmlGenerator exists before calling
            if (typeof htmlGenerator !== 'undefined') {
                try {
                    const code = htmlGenerator.workspaceToCode(workspace);
                    document.getElementById('codeOutput').textContent = code;
                    
                    const previewFrame = document.getElementById('livePreview');
                    const previewDoc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                    previewDoc.open();
                    previewDoc.write(code);
                    previewDoc.close();
                } catch (e) {
                    console.error("Generation Error:", e);
                }
            }
        }

        workspace.addChangeListener(updateAll);

        function copyCode() {
            const code = document.getElementById('codeOutput').textContent;
            navigator.clipboard.writeText(code);
            alert("Code copied!");
        }
    </script>
</body>
</html>
